<style type='text/css'>
  #app_$app_id {
    display: grid;
    grid-column-gap: 15px;
    grid: 100vh / 250px auto;
    height: 100vh;
  }
  #processor_list_$app_id {
    grid-column: 1;
    grid-row: 1;
    width: 250px;
    height: 100vh;
    overflow-y: auto;
  }
  #pipeline_$app_id {
    grid-column: 2;
    grid-row: 1;
    overflow-y: auto;
  }
  #remove_last_div {
    position: absolute;
    bottom: 10px;
    right: 28px;
  }
  #remove_last_div::before {
    font-family: arial;
    font-size: 28px;
    content: '\2715';
    color: red;
  }
  .processor_block {
    width: 220px;
    margin: 5px;
    padding: 5px;
    border-radius: 15px;
    color: darkblue;
    font-weight: bold;
  }
  .playable::before {
    font-family: 'Webdings';
    font-size: 28px;
    content: '\25B6';
    top: 0px;
    left: 12px;
    padding-right: 4px;
    color: green;
  }
  .processor_instance {
    margin: 10px;
    border-radius: 25px;
    padding-left: 25px;
    padding-right: 25px;
    padding-top: 5px;
    padding-bottom: 5px;
    color: black;
  }
  .proc_inst_name {
    font-size: 14pt;
    font-weight: bold;
    font-variant: small-caps;
    color: #0f494f;
  }

  .folder_bytes          { background-color: #888; }
  .folder_custom         { background-color: #999; }
  .folder_datastructures { background-color: #f9f; }
  .folder_file           { background-color: #99f; }
  .folder_flow           { background-color: #ff9; }
  .folder_interact       { background-color: #9f9; }
  .folder_math           { background-color: #9ff; }
  .folder_strings        { background-color: #ccc; }
  .folder_variables      { background-color: #f99; }
  .folder_web            { background-color: #fcc; }

  .disabled {
    background-color: #666;
    color: #999;
    border: thin solid #633;
    display: none;
  }
  .processor_output_type {
    font-variant: all-caps;
    padding-left: 50px;
  }
  .processor_output_type::before {
    content: "=> ";
  }
  .numeric {
    color: black;
  }
  .string {
    color: green;
  }
  .list {
    color: darkyellow;
  }
  .bytestream {
    color: purple;
  }
</style>

<div id='app_$app_id'>
  <div id='processor_list_$app_id'>
  </div>
  <div id='pipeline_$app_id'>
    <div id='remove_last_div' onclick='stax_$app_id.remove_block_from_pipeline()'></div>
  </div>
</div>

<script type='text/javascript'>
  var debug;

  class Stax_$app_id {
    constructor() {
      this.processors = {};
      this.last_output = 'None';
      this.pipeline = [];
      this.output_id = undefined;
    }
    get_proc(name) {
      return this.processors[name];
    }
    render_block(proc) {
      var button = $("<div class='processor_block folder_"+proc['folder']+"'>"+proc['name']+"</div>");
      button.click(this.add_block_to_pipeline_cb);
      $('#processor_list_$app_id').append(button);
    }
    render_processor(proc) {
      var name = proc['name'];
      var folder_class = 'folder_'+proc['folder'];
      var output_type = proc['output'];
      var params = proc['parameters'];
      // render parameters
      var param_form = "";
      if(params.length > 0) {
        param_form = "<form><table>";
        for(var i in params) {
          var p = params[i];
          var d = "";
          if(p['default']) {
            d = " value='" + p['default'] + "'";
          }
          var input_id = uuid1();
          p['id'] = input_id;
          param_form += "<tr>";
          param_form += "<th>" + p['name'] + "</th>";
          if ( p['type'] == 'textarea' ) {
            d = p['default'] || ""
            param_form += "<td><textarea id='" + input_id + "' class='outputs'>" + d + "</textarea></td>";
          } else if ( p['type'] == 'boolean' ) {
            d = '';
            if(p['default']) { d = 'checked'; }
            param_form += "<td><input type='checkbox' id='" + input_id + "'" + d + "></td>";
          } else if ( p['type'] == 'combo' ) {
            d = p['default'];
            param_form += "<td><select id='"+ input_id + "'>";
            for(var i in p['options']) {
              var op = p['options'][i]
              param_form += "<option value='"+ op +"'";
              if( d == op ) {
                param_form += " checked";
              }
              param_form += ">"+op+"</option>\n";
            }
            param_form += "</select></td>\n";
          } else {
            param_form += "<td><input type='" + p['type'] + "' id='" + input_id + "'" + d + "></td>";
          }
          param_form += "</tr>\n";
        }
      }
      // create the next pipeline processor id
      var proc_id = this.pipeline.length;

      // append the processor to the pipeline visualization
      if(proc['inputs'].indexOf('None') > -1) {
        $('#pipeline_$app_id').append(
          "<div data-proc-id='"+ proc_id +"' class='processor_instance "+folder_class+" playable' onclick='stax_$app_id.submit_pipeline(this.dataset.procId);'><span class='proc_inst_name'>"+name+"</span>"+param_form+"</div>"
        );
      } else {
        $('#pipeline_$app_id').append(
          "<div data-proc-id='"+ proc_id +"' class='processor_instance "+folder_class+"'><span class='proc_inst_name'>"+name+"</span>"+param_form+"</div>"
        );
      }

      $('#pipeline_$app_id').append(
        "<div class='processor_output_type "+output_type+"'>"+output_type+"</div>"
      );
      if(output_type != 'input') {
        this.last_output = output_type;
        this.activate_valid_blocks();
      }
    }
    activate_valid_blocks() {
      var self = this;
      $('#processor_list_$app_id .processor_block').each(function(index, ele) {
        var name = ele.innerText;
        var proc = self.get_proc(name);
        if(proc['inputs'].indexOf(self.last_output) == -1) {
          ele.classList.add('disabled');
        } else {
          ele.classList.remove('disabled');
        }
      });
    }
    add_block_to_pipeline_cb() {
      var self = stax_$app_id;
      var button = $( this )[0];
      var name = button.innerText;
      self.add_block_to_pipeline(name, undefined);
    }
    add_block_to_pipeline(name, parameters) {
      // if parameters is undefined, then it defaults to the defaults
      console.log(name);
      // copy the Proc Block to a Proc Instance
      var proc = Object.assign({}, this.get_proc(name));
      console.log(proc);
      // copy the Parameters
      var params = [];
      for(var i in proc['parameters']) {
        params.push(Object.assign({}, proc['parameters'][i]));
      }
      proc['parameters'] = params;
      console.log(proc['parameters']);
      console.log(parameters);

      // check if the last output is compatible.
      if(proc['inputs'].indexOf(this.last_output) == -1) {
        alert("Last output type was "+this.last_output+". "+name+" takes in one of "+input_types.join(", ") );
      } else {
        this.render_processor(proc);
        this.pipeline.push(proc);
      }
    }
    remove_block_from_pipeline() {
      var self = stax_$app_id;

      if ( self.pipeline.length == 0 ) { return; }

      var proc_id = self.pipeline.length - 1;
      self.pipeline.pop();
      var ele = $(".processor_instance[data-proc-id="+proc_id+"]");
      // need to update the last output type
      console.log(ele.prev());
      self.last_output = ele.prev().text();
      if(self.last_output == undefined) {
        self.last_output = 'None';
      }
      console.log(self.last_output);
      ele.next().remove();
      ele.remove();
      self.activate_valid_blocks();
    }
    render_processor_blocks(data) {
      var self = stax_$app_id;
      self.processors = data;
      for(var i in self.processors) {
        var proc = self.processors[i];
        self.render_block(proc);
      }
      self.activate_valid_blocks();
      self.render_menu_buttons();
      if(localStorage.getItem("last_pipeline") != undefined) {
        self.load_pipeline("last_pipeline")
      }
    }
    to_data(start) {
      if(start == undefined) {
        start = 0;
      }
      var pipeline = [];
      for( var i in this.pipeline ) {
        var block = this.pipeline[i];
        var processor_name = block['name'];
        var params = {};
        for ( var j in block['parameters' ] ) {
          var p = block['parameters'][j];
          var input_id = p['id'];
          var input_value = $('#'+input_id)[0].value;
          if (p['type'] == "boolean") {
            input_value = $('#'+input_id)[0].checked;
          } else if (p["type"] == "number") {
            input_value = parseInt(input_value);
          }
          var input_name = p['name'];
          params['id'] = input_id;
          params[input_name] = input_value;
        }
        pipeline.push( { 'processor': processor_name, 'parameters': params } );
      }
      return { pipeline: pipeline, submit_time: Date.now(), start: start };
    }
    to_json(start) {
      return JSON.stringify(this.to_data(start));
    }
    submit_pipeline(start) {
      $(".outputs").val("");

      var pipeline = this.to_json(0);
      localStorage.setItem("last_pipeline", pipeline);

      call_function_callback("$app_id", this.to_json(start), "run_pipeline", (data) => {
        console.log(data);
        if(data['type'] == 'output' && data['id']) {
          var message = data['message'];
          if(typeof message == "string" || typeof message == "number") {
            $("#"+data['id'])[0].value += message;
          } else {
            $("#"+data['id'])[0].value += JSON.stringify(message);
          }
        } else {
          alert(JSON.stringify(data));
        }
      });
    }
    load_pipeline(name) {
      var job = JSON.parse(localStorage.getItem(name));
      var pipeline = job['pipeline'];
      for( var i in pipeline ) {
        var block = pipeline[i];
        this.add_block_to_pipeline(block['processor'], block['parameters']);
      }
    }
    save_pipeline(name) {
      localStorage.setItem(name, this.to_json(0));
    }
    clear_pipeline() {
      this.last_output = 'None';
      this.pipeline = [];
      this.output_id = undefined;
      $('#pipeline_$app_id').empty();
      this.render_menu_buttons();
    }
    render_menu_buttons() {
      $('#pipeline_$app_id').append("<input type='button' value='load' onclick='stax_$app_id.load_dialog()'>");
      $('#pipeline_$app_id').append("<input type='button' value='save' onclick='stax_$app_id.save_dialog()'>");
      $('#pipeline_$app_id').append("<input type='button' value='clear' onclick='stax_$app_id.clear_dialog()'>");
    }
    load_dialog() {
      var pipeline_names = [];
      for( var i=0; i < localStorage.length; i++) {
        pipeline_names.push(localStorage.key(i));
      }
      var name = prompt("Load pipeline: "+pipeline_names.join(', '), 'last_pipeline');
      if(name == undefined) {
        return;
      }
      if(localStorage.getItem(name)) {
        this.load_pipeline(name);
      } else {
        alert("Could not find a saved pipeline with the name "+name);
      }
    }
    save_dialog() {
      var name = prompt("Save pipeline as...", new Date().toISOString());
      if(name == undefined) {
        return;
      }
      this.save_pipeline(name);
      alert("Saved pipeline.")
    }
    clear_dialog() {
      if(confirm("Do you want to clear the current pipeline?")) {
        this.clear_pipeline();
      }
    }

  }
  var stax_$app_id = new Stax_$app_id();
  call_function_callback("$app_id", '{}', 'list_processors', stax_$app_id.render_processor_blocks);

</script>
